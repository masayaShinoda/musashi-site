{% extends "layout/layout.html" %} 
{% load static %} 
{% block content %}

<main 
  x-data="productGallery()"
  class="w-full max-w-full md:max-w-7xl mx-auto min-h-[80dvh] px-4 pt-16 pb-12"
>
  <!-- START product gallery AND product details section -->
  <section class="w-full max-w-full grid sm:grid-cols-2 gap-10 mb-16">
    <!-- START product gallery section -->
    <section class="">
      <div  
        class="flex flex-col gap-4 w-full max-w-2xl"
      >
        <div class="relative w-full aspect-square bg-gray-100 border border-gray-200 rounded-sm overflow-hidden group">
          
          <img 
            :src="activeImage.url" 
            :alt="activeImage.alt" 
            class="w-full h-full object-cover object-center transition-transform duration-500"
            :class="{ 'scale-105': zoom }"
            @mouseenter="zoom = true" 
            @mouseleave="zoom = false"
            loading="lazy"
          >

          <template x-if="!activeImage.url">
            <div class="w-full h-full flex items-center justify-center text-gray-400">
              <span>No image available</span>
            </div>
          </template>
          
          <template x-if="activeImage.volume_name">
            <span 
              class="absolute top-2 left-2 bg-black/70 text-white text-xs font-semibold px-2 py-1 rounded-sm" 
              x-text="activeImage.volume_name">
            </span>
          </template>
        </div>

        <div class="flex flex-col gap-2">
          <p class="text-sm text-gray-500 font-medium">
            Images for: <span x-text="currentVolumeFilter || 'All Volumes'"></span>
          </p>
          
          <div class="grid grid-cols-4 sm:flex flex-wrap gap-2 min-h-20">
            <template x-for="img in filteredImages" :key="img.id">
              <button 
                @click="setActive(img)"
                class="cursor-pointer w-20 h-20 border-2 rounded-sm overflow-hidden transition-all duration-200"
                :class="activeImage.id === img.id ? 'border-brand ring-1 ring-brand' : 'border-transparent opacity-70 hover:opacity-100'"
              >
                <img 
                  :src="img.url" 
                  :alt="img.alt" 
                  class="w-full h-full object-cover"
                >
              </button>
            </template>
          </div>
        </div>
      </div>
    </section>
    <!-- END product gallery section -->

    <!-- START product details section -->
    <section class="sm:pl-1 lg:pl-10 xl:pl-20">
      <header class="w-full flex flex-col gap-4 justify-start items-start">
        <h1 class="text-2xl sm:text-3xl xl:text-4xl font-semibold">{{ product.name }}</h1>
        {% if product.categories %}
          <div>
            {% for category in product.categories.all %}
            <p class="font-semisemibold text-gray-600">
              {{ category.name }}&nbsp;
            </p>
            {% endfor %}
          </div>
        {% endif %}
      </header>
      <div class="mt-4 border-t pt-4 border-t-gray-300">
        <label class="text-sm font-semisemibold text-gray-900">Select Volume:</label>
        <div class="flex gap-2 mt-2">
          <button 
            @click="filterByVolume(null)" 
            class="cursor-pointer px-3 py-1 text-sm border rounded-sm"
            :class="currentVolumeFilter === null ? 'bg-gray-800 text-white' : 'bg-white text-gray-800'"
          >
            All
          </button>

          {% for variant in product.variants.all %}
          <button 
            @click="filterByVolume('{{ variant.volume.name }}', {{ variant.volume.id }})" 
            class="cursor-pointer px-3 py-1 text-sm border rounded-sm transition"
            :class="currentVolumeFilter === '{{ variant.volume.name }}' ? 'bg-gray-800 text-white' : 'bg-white text-gray-800 hover:bg-gray-50'"
          >
            {{ variant.volume.name }}
          </button>
          {% endfor %}
        </div>
      </div>
      {% if product.detail_items.all %}
      <div class="py-10 w-full">
        <h3 class="text-gray-800 font-semisemibold text-base sm:text-lg md:text-xl mb-2">Details</h3>
        <table class="w-full text-sm sm:text-base">
        {% for item in product.detail_items.all  %}
          <tr> 
            <td class="text-gray-500 py-2">{{ item.name }}</td>
            <td class="text-gray-700 py-2 text-right">{{ item.value }}</td>
          </tr>
        {% endfor %}
        </table>
      </div>
      {% endif %}
      <div class="py-5 w-full grid sm:grid-cols-2 gap-4">
        <a href="#" class="cursor-pointer inline-flex items-center justify-center text-base leading-6 text-gray-100 py-3 px-6 rounded-full bg-gray-900 border border-gray-900 hover:bg-gray-800 focus-visible:bg-gray-800 active:bg-gray-950 transition-colors">
          <span>
          Place Order
          </span>
        </a>
      {% if product.data_sheet %}
        <a href="{% get_media_prefix %}{{ product.data_sheet }}" class="cursor-pointer inline-flex items-center justify-center text-base leading-6 text-gray-800 py-3 px-6 rounded-full border border-brand">
          <img src="{% static 'icons/download.svg' %}" alt="Download icon" width="20" height="20" class="mr-1.5">
          <span>Data Sheet</span>
        </a>
      {% endif %}
      </div>
    </section>
    <!-- END product details section -->


    <script>
      function productGallery() {
        return {
          // Initial data injected from Django
          allImages: [
            {% for image in product.images.all %}
            {
              id: {{ image.id }},
              url: "{{ image.image.url }}",
              alt: "{{ image.alt|default:product.name|escapejs }}",
              volume_id: {% if image.for_volume %}{{ image.for_volume.id }}{% else %}null{% endif %},
              volume_name: "{% if image.for_volume %}{{ image.for_volume.name }}{% else %}{% endif %}"
            },
            {% endfor %}
          ],
          
          activeImage: { url: '', alt: '' },
          currentVolumeFilter: null, // null means 'Show All'
          currentVolumeId: null,
          variants: [
            {% for variant in product.variants.all %}
            {
              id: {{ variant.volume.id }},
              name: "{{ variant.volume.name }}",
              price: "{{ variant.price }}" 
            },
            {% endfor %}
          ],
          zoom: false,

          priceString: "{{ product.get_price_display }}",

          get currentPriceDisplay() {
            // If a specific volume is selected, show that specific price
            if (this.currentVolumeId) {
              const variant = this.variants.find(v => v.id === this.currentVolumeId);
              return variant ? `$${variant.price}` : 'Price N/A';
            }
            
            // Otherwise, return the Range string we calculated in Python
            return this.priceString;
          },

          init() {
            if (this.allImages.length > 0) {
              this.activeImage = this.allImages[0];
            }
          },

          get filteredImages() {
            if (!this.currentVolumeId) {
              return this.allImages;
            }
            return this.allImages.filter(img => 
              img.volume_id === null || img.volume_id === this.currentVolumeId
            );
          },

          setActive(img) {
            this.activeImage = img;
          },

          filterByVolume(name, id = null) {
            this.currentVolumeFilter = name;
            this.currentVolumeId = id;

            // Auto-switch main image if specific volume selected
            if (id) {
              const firstVolImage = this.allImages.find(img => img.volume_id === id);
              if (firstVolImage) {
                this.activeImage = firstVolImage;
              }
            }
          }
        }
      }
    </script>
  </section>
  <!-- END product gallery AND product details section -->
  <!-- START tabbed description section -->
  <section class="w-full max-w-full flex flex-col min-h-[40dvh]">
    {% if product.description or product.instructions or product.standards_and_approval %}
    <div x-data="{ activeTab: '{% if product.description %}description{% elif product.instructions %}instructions{% else %}standards{% endif %}' }" class="p-2 sm:p-4 border border-gray-200 rounded-lg">
      <!-- Tab Navigation -->
      <div class="flex space-x-4 border-b border-gray-300 mb-4">
        {% if product.description %}
        <button 
          @click="activeTab = 'description'" 
          :class="activeTab === 'description' ? 'border-b-2 border-brand font-semibold' : 'text-gray-500'"
          class="cursor-pointer py-2 px-4"
        >
          Description
        </button>
        {% endif %}

        {% if product.instructions %}
        <button 
          @click="activeTab = 'instructions'" 
          :class="activeTab === 'instructions' ? 'border-b-2 border-brand font-semibold' : 'text-gray-500'"
          class="cursor-pointer py-2 px-4"
        >
          Instruction Manual
        </button>
        {% endif %}

        {% if product.standards_and_approval %}
        <button 
          @click="activeTab = 'standards'" 
          :class="activeTab === 'standards' ? 'border-b-2 border-brand font-semibold' : 'text-gray-500'"
          class="cursor-pointer py-2 px-4"
        >
          Standards & Approvals
        </button>
        {% endif %}
      </div>

      <!-- Tab Content -->
      <div class="text-sm lg:text-base text-gray-700 leading-normal py-4 sm:px-6">
        {% if product.description %}
        <div x-show="activeTab === 'description'" x-transition>
          <div>{{ product.description|safe }}</div>
        </div>
        {% endif %}

        {% if product.instructions %}
        <div x-show="activeTab === 'instructions'" x-transition>
          {% if product.instructions.pdf_manual %}
            <section class="mb-6">
              <a href="{% get_media_prefix %}{{ product.instructions.pdf_manual }}" class="cursor-pointer inline-flex items-center justify-center text-base leading-6 text-gray-800 py-3 px-6 rounded-full border border-brand">
                <img src="{% static 'icons/download.svg' %}" alt="Download icon" width="20" height="20" class="mr-1.5">
                <span>Instruction Manual (PDF)</span>
              </a>
            </section>
          {% endif %}
          {% if product.instructions.instruction_steps %}
            <div>{{ product.instructions.instruction_steps|safe }}</div>
          {% endif %}
        </div>
        {% endif %}

        {% if product.standards_and_approval %}
        <div x-show="activeTab === 'standards'" x-transition>
          <div>{{ product.standards_and_approval|safe }}</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </section>
  <!-- END tabbed description section -->
</main>

{% endblock %}
